<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receituário Pro - Sistema Profissional de Prescrições</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-dark: #1a202c;
            --text-light: #718096;
            --white: #ffffff;
            --gray-light: #f7fafc;
            --success: #48bb78;
            --error: #f56565;
            --warning: #ed8936;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
        }

        .trial-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-white {
            background: white;
            color: var(--primary);
        }

        .btn-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--gray-light);
            padding: 20px;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Template Selector */
        .template-section {
            margin-bottom: 25px;
        }

        .template-section h3 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .template-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .template-card.active {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
        }

        .template-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .template-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Form Controls */
        .form-section {
            margin-bottom: 20px;
        }

        .form-section label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Signature Controls */
        .signature-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Preview Area */
        .preview-container {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            overflow-y: auto;
        }

        .prescription-wrapper {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .prescription-preview {
            background: white;
            padding: 40px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            min-height: 600px;
        }

        .prescription-header {
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            background: linear-gradient(to right, #f7fafc 0%, white 100%);
            border-left: 4px solid var(--primary);
        }

        .clinic-logo-placeholder {
            width: 150px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .doctor-info h2 {
            color: var(--text-dark);
            font-size: 18px;
            margin-bottom: 5px;
        }

        .doctor-info p {
            color: var(--text-light);
            margin: 2px 0;
            font-size: 13px;
        }

        .patient-info {
            margin-bottom: 25px;
            padding: 15px;
            background: var(--gray-light);
            border-radius: 8px;
        }

        .patient-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .prescription-content {
            min-height: 350px;
            margin-bottom: 30px;
        }

        .prescription-text-display {
            min-height: 350px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.8;
            background: white;
            white-space: pre-wrap;
            outline: none;
        }

        .prescription-text-display:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .signature-section {
            margin-top: 40px;
            text-align: center;
        }

        .signature-canvas {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            margin: 15px auto;
        }

        .signature-line {
            border-top: 2px solid #333;
            width: 300px;
            margin: 10px auto;
            padding-top: 8px;
        }

        /* Action Buttons */
        .action-buttons {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            font-size: 14px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--error);
        }

        .toast.warning {
            background: var(--warning);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }

            .prescription-preview {
                padding: 20px;
            }
        }

        @media print {
            body {
                background: white;
            }

            .header, .sidebar, .action-buttons {
                display: none !important;
            }

            .preview-container {
                padding: 0;
                background: white;
            }

            .prescription-preview {
                box-shadow: none;
                padding: 20px;
            }

            .prescription-text-display {
                border: none;
            }
        }

        .cid-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .cid-result-item:hover {
            background: var(--gray-light);
        }

        .cid-result-item:last-child {
            border-bottom: none;
        }

        .cid-result-code {
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
        }

        .cid-result-desc {
            color: var(--text-dark);
            font-size: 12px;
            margin-top: 2px;
        }

        .cid-loading {
            padding: 15px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }

        .cid-no-results {
            padding: 15px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
            </style>
</head>
<body>
    <!-- Include Supabase Config -->
    <script src="js/supabase-config.js"></script>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>📋</span>
                Receituário Pro
            </h1>
            <div class="header-actions">
                <div class="trial-info" id="trialInfo">
                    <span id="trialText">Carregando...</span>
                </div>
                <div class="user-info">
                    <span>👤</span>
                    <span id="userName">Carregando...</span>
                </div>
                <a href="profile.html" class="btn btn-white">⚙️ Perfil</a>
                <button class="btn btn-white" onclick="logout()">🚪 Sair</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Template Selection -->
                <div class="template-section">
                    <h3>📝 Tipo de Receituário</h3>
                    <div class="template-grid">
                        <div class="template-card active" data-template="medicacao" onclick="selectTemplate('medicacao')">
                            <div class="template-icon">💊</div>
                            <div class="template-name">Medicação</div>
                        </div>
                        
                        <div class="template-card" data-template="exames" onclick="selectTemplate('exames')">
                            <div class="template-icon">🔬</div>
                            <div class="template-name">Exames</div>
                        </div>
                        
                        <div class="template-card" data-template="procedimento" onclick="selectTemplate('procedimento')">
                            <div class="template-icon">🏥</div>
                            <div class="template-name">Encaminhamento</div>
                        </div>
                        
                        <div class="template-card" data-template="atestado" onclick="selectTemplate('atestado')">
                            <div class="template-icon">📋</div>
                            <div class="template-name">Atestado</div>
                        </div>
                        
                        <div class="template-card" data-template="laudo" onclick="selectTemplate('laudo')">
                            <div class="template-icon">📄</div>
                            <div class="template-name">Laudo</div>
                        </div>
                        
                        <div class="template-card" data-template="livre" onclick="selectTemplate('livre')">
                            <div class="template-icon">✏️</div>
                            <div class="template-name">Livre</div>
                        </div>
                    </div>
                </div>

                <!-- Patient Info -->
                <div class="form-section">
                    <label for="patientName">👤 Nome do Paciente</label>
                    <input type="text" id="patientName" class="form-control" 
                           placeholder="Digite o nome do paciente"
                           oninput="updatePatientDisplay()">
                </div>

                <div class="form-section">
                    <label for="prescriptionDate">📅 Data</label>
                    <input type="date" id="prescriptionDate" class="form-control" 
                           onchange="updateDateDisplay()">
                </div>
                <!-- CID-10 Search Section -->
<div class="form-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
    <label style="display: flex; align-items: center; gap: 5px;">
        🔍 Buscar CID-10
        <span style="font-size: 11px; color: var(--text-light); font-weight: normal;">
            (código ou descrição)
        </span>
    </label>
    <div style="position: relative;">
        <input type="text" 
               id="cidSearch" 
               class="form-control" 
               placeholder="Ex: J00 ou gripe"
               autocomplete="off">
        
        <!-- Resultados da busca -->
        <div id="cidResults" 
             style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                    max-height: 300px; overflow-y: auto; background: white; 
                    border: 2px solid var(--primary); border-radius: 8px; 
                    margin-top: 5px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        </div>
    </div>
    
    <!-- CID Selecionado -->
    <div id="selectedCid" 
         style="display: none; margin-top: 10px; padding: 10px; 
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); 
                border-radius: 8px; border-left: 3px solid var(--primary);">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
                <strong style="color: var(--primary); font-size: 14px;" id="selectedCidCode">-</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-dark); line-height: 1.4;" 
                   id="selectedCidDesc">-</p>
            </div>
            <button onclick="clearSelectedCid()" 
                    style="background: none; border: none; color: var(--error); 
                           cursor: pointer; padding: 0; font-size: 18px;">
                ×
            </button>
        </div>
    </div>
</div>



                <!-- Signature Section -->
                <div class="form-section">
                    <label>✍️ Assinatura Digital</label>
                    <canvas id="signatureCanvas" class="signature-canvas" width="280" height="80"></canvas>
                    <div class="signature-controls">
                        <button class="btn-secondary" onclick="clearSignature()">Limpar</button>
                        <button class="btn-secondary" onclick="document.getElementById('signatureUpload').click()">
                            Upload
                        </button>
                        <input type="file" id="signatureUpload" accept="image/*" 
                               style="display: none;" onchange="handleSignatureUpload(event)">
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="preview-container">
                <div class="prescription-wrapper">
                    <div class="prescription-preview" id="prescriptionPreview">
                        <!-- Header -->
                        <div class="prescription-header">
                            <div id="clinicLogoContainer">
                                <div class="clinic-logo-placeholder" id="logoPlaceholder">
                                    RECEITUÁRIO PRO
                                </div>
                            </div>
                            <div class="doctor-info">
                                <h2 id="doctorName">Dr. Nome do Médico</h2>
                                <p id="doctorCRM">CRM: 00000-UF</p>
                                <p id="doctorSpecialty">Especialidade</p>
                                <p id="doctorPhone">Telefone: (00) 00000-0000</p>
                                <p id="doctorAddress" style="display: none;"></p>
                            </div>
                        </div>

                        <!-- Patient Info -->
                        <div class="patient-info">
                            <p><strong>Paciente:</strong> <span id="patientDisplay">_________________________</span></p>
                            <p><strong>Data:</strong> <span id="dateDisplay">__/__/____</span></p>
                        </div>

                        <!-- Content -->
                        <div class="prescription-content">
                            <div class="prescription-text-display" 
                                 id="prescriptionTextDisplay"
                                 contenteditable="true">Digite aqui o conteúdo do receituário...</div>
                        </div>

                        <!-- Signature -->
                        <div class="signature-section">
                            <canvas id="signaturePreview" class="signature-canvas" 
                                    width="300" height="100" style="display: none;"></canvas>
                            <div class="signature-line">
                                <p id="signatureName" style="margin-top: 8px; font-weight: 500;">
                                    Dr. Nome do Médico
                                </p>
                                <p id="signatureCRM" style="color: var(--text-light); font-size: 12px;">
                                    CRM: 00000-UF
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generatePDF()">
                            📄 Gerar PDF
                        </button>
                        <button class="btn btn-primary" onclick="generatePNG()">
                            🖼️ Gerar Imagem
                        </button>
                        <button class="btn btn-primary" onclick="savePrescription()">
                            💾 Salvar no Histórico
                        </button>
                    </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Trial Expired Modal -->
<div id="trialExpiredModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; text-align: center; animation: slideUp 0.5s;">
        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(237, 137, 54, 0.1) 0%, rgba(237, 137, 54, 0.2) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px;">
            ⏰
        </div>
        <h2 style="color: #1a202c; margin-bottom: 15px;">Seu Trial Expirou!</h2>
        <p style="color: #718096; margin-bottom: 25px; line-height: 1.6;">
            Seu período de teste gratuito de 30 dias terminou. 
            Para continuar criando receituários ilimitados, faça upgrade para o Plano Essencial.
        </p>
        
        <div style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">🎁 Oferta Especial</h3>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                <div style="flex: 1; padding: 15px; background: white; border-radius: 10px; border: 2px solid #667eea;">
                    <strong style="color: #1a202c;">Mensal</strong><br>
                    <span style="font-size: 24px; color: #667eea; font-weight: bold;">R$ 39</span><br>
                    <small style="color: #718096;">por mês</small>
                </div>
                <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 10px; border: 2px solid #667eea; position: relative;">
                    <div style="position: absolute; top: -10px; right: 10px; background: #48bb78; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">-25%</div>
                    <strong style="color: #1a202c;">Anual</strong><br>
                    <span style="font-size: 24px; color: #667eea; font-weight: bold;">R$ 29</span><br>
                    <small style="color: #718096;">por mês</small>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="showUpgradeModal()" 
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                💳 Fazer Upgrade Agora
            </button>
            <button onclick="closeTrialModal()" 
                    style="padding: 12px 20px; background: #f7fafc; color: #1a202c; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
        </div>
        
        <p style="margin-top: 15px; font-size: 12px; color: #718096;">
            Cancele a qualquer momento • Sem fidelidade
        </p>
    </div>
</div>

<!-- Modal de Escolha de Plano -->
<div id="planChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 style="text-align: center; color: #1a202c; margin-bottom: 10px;">
            🚀 Escolha seu Plano
        </h2>
        <p style="text-align: center; color: #718096; margin-bottom: 30px;">
            Desbloqueie todo o potencial do Receituário Pro
        </p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- Plano Mensal -->
            <div style="border: 2px solid #e2e8f0; border-radius: 15px; padding: 25px; text-align: center; transition: all 0.3s; cursor: pointer;"
                 onclick="goToStripeCheckout('monthly')"
                 onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-5px)'"
                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'">
                <h3 style="color: #1a202c; margin-bottom: 10px;">Mensal</h3>
                <div style="margin: 20px 0;">
                    <span style="font-size: 36px; font-weight: bold; color: #667eea;">R$ 39</span>
                    <span style="color: #718096;">/mês</span>
                </div>
                <ul style="list-style: none; padding: 0; margin: 20px 0; text-align: left; font-size: 14px;">
                    <li style="padding: 8px 0;">✅ Receituários ilimitados</li>
                    <li style="padding: 8px 0;">✅ Todos os templates</li>
                    <li style="padding: 8px 0;">✅ Suporte prioritário</li>
                    <li style="padding: 8px 0;">✅ Cancele quando quiser</li>
                </ul>
                <button style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                    Escolher Mensal
                </button>
            </div>
            
            <!-- Plano Anual -->
            <div style="border: 2px solid #667eea; border-radius: 15px; padding: 25px; text-align: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); position: relative; transform: scale(1.05);"
                 onclick="goToStripeCheckout('yearly')"
                 style="cursor: pointer;">
                <div style="position: absolute; top: -12px; right: 20px; background: #48bb78; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                    ECONOMIA DE 25%
                </div>
                <h3 style="color: #1a202c; margin-bottom: 10px;">Anual</h3>
                <div style="margin: 20px 0;">
                    <span style="font-size: 36px; font-weight: bold; color: #667eea;">R$ 29</span>
                    <span style="color: #718096;">/mês</span>
                </div>
                <p style="color: #48bb78; font-size: 14px; margin: -10px 0 20px;">
                    Economize R$ 120/ano!
                </p>
                <ul style="list-style: none; padding: 0; margin: 20px 0; text-align: left; font-size: 14px;">
                    <li style="padding: 8px 0;">✅ Tudo do plano mensal</li>
                    <li style="padding: 8px 0;">🎁 3 meses grátis</li>
                    <li style="padding: 8px 0;">💰 Melhor custo-benefício</li>
                    <li style="padding: 8px 0;">🔒 Preço garantido por 1 ano</li>
                </ul>
                <button style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                    Escolher Anual
                </button>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button onclick="closePlanModal()" 
                    style="background: #f7fafc; color: #1a202c; padding: 10px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
        </div>
        
        <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #718096;">
            🔒 Pagamento seguro via Stripe • Cancele quando quiser
        </p>
    </div>
</div>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentUser = null;
        let currentSubscription = null;
        let currentTemplate = 'medicacao';
        let signatureCanvas = null;
        let signatureCtx = null;
        let isDrawing = false;
        let cidData = [];
        let currentCidInput = null;
        // ========================================
// TEMPLATES MELHORADOS - Substituir no app.html
// ========================================

const templates = {
    medicacao: {
        title: 'Receituário de Medicação',
        content: `<strong>USO INTERNO</strong><br><br>

<strong>1.</strong> <input type="text" placeholder="Nome do medicamento + dosagem" style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Posologia:</em> <input type="text" placeholder="Ex: 1 comprimido de 8/8 horas" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Quantidade:</em> <input type="text" placeholder="Ex: 30 comprimidos" style="width: 200px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>2.</strong> <input type="text" placeholder="Nome do medicamento + dosagem" style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Posologia:</em> <input type="text" placeholder="Ex: 1 cápsula pela manhã em jejum" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Quantidade:</em> <input type="text" placeholder="Ex: 30 cápsulas" style="width: 200px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>3.</strong> <input type="text" placeholder="Nome do medicamento + dosagem" style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Posologia:</em> <input type="text" placeholder="Posologia" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;&nbsp;<em>Quantidade:</em> <input type="text" placeholder="Quantidade" style="width: 200px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Orientações:</strong><br>
<textarea placeholder="Digite as orientações gerais para o paciente..." style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea>`
    },
    
    exames: {
        title: 'Solicitação de Exames',
        content: `<strong>SOLICITO OS SEGUINTES EXAMES:</strong><br><br>

<strong>EXAMES LABORATORIAIS:</strong><br>
☐ Hemograma completo com plaquetas<br>
☐ Glicemia de jejum<br>
☐ Hemoglobina glicada (HbA1c)<br>
☐ Colesterol total e frações (HDL, LDL)<br>
☐ Triglicerídeos<br>
☐ TGO/TGP (transaminases)<br>
☐ Ureia e creatinina<br>
☐ Ácido úrico<br>
☐ TSH e T4 livre<br>
☐ Vitamina D (25-OH)<br>
☐ Vitamina B12<br>
☐ Ferritina<br>
☐ PCR (proteína C reativa)<br>
☐ VHS (velocidade de hemossedimentação)<br>
☐ Urina tipo I (EAS)<br><br>

<strong>EXAMES DE IMAGEM:</strong><br>
☐ Raio-X de tórax<br>
☐ Ultrassom de abdome total<br>
☐ Ecocardiograma<br>
☐ <input type="text" placeholder="Outro exame" style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Observações clínicas:</strong><br>
<textarea placeholder="Informações clínicas relevantes para o laboratório..." style="width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>Hipótese diagnóstica/CID:</strong><br>
<input type="text" placeholder="Digite o CID ou descrição" data-cid="true" style="width: 400px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;">`
    },
    
    procedimento: {
        title: 'Encaminhamento Médico',
        content: `<strong>ENCAMINHAMENTO MÉDICO</strong><br><br>

<strong>Prezado(a) Colega,</strong><br><br>

Encaminho o(a) paciente acima identificado(a) para:<br>
☐ Cardiologia &nbsp;&nbsp;&nbsp; ☐ Endocrinologia &nbsp;&nbsp;&nbsp; ☐ Gastroenterologia<br>
☐ Neurologia &nbsp;&nbsp;&nbsp; ☐ Ortopedia &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ☐ Dermatologia<br>
☐ Ginecologia &nbsp;&nbsp;&nbsp; ☐ Urologia &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ☐ Pneumologia<br>
☐ Oftalmologia &nbsp;&nbsp;&nbsp; ☐ Otorrinolaringologia<br>
☐ Outros: <input type="text" placeholder="Especificar especialidade" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Motivo do encaminhamento:</strong><br>
<textarea placeholder="Descreva o motivo do encaminhamento..." style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>Diagnóstico principal/CID:</strong><br>
<input type="text" placeholder="Digite o CID ou descrição" data-cid="true" style="width: 400px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>História clínica resumida:</strong><br>
<textarea placeholder="Resumo da história clínica do paciente..." style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>Exames já realizados:</strong><br>
<textarea placeholder="Liste os exames já realizados e seus resultados..." style="width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>Medicações em uso:</strong><br>
<textarea placeholder="Liste as medicações atuais do paciente..." style="width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

Atenciosamente,`
    },
    
    atestado: {
        title: 'Atestado Médico',
        content: `<center><strong>ATESTADO MÉDICO</strong></center><br><br>

Atesto para os devidos fins que o(a) paciente acima identificado(a) esteve sob meus cuidados médicos e <strong>necessita se afastar de suas atividades</strong> por motivo de:<br><br>

☐ Doença &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ☐ Repouso médico<br>
☐ Procedimento médico &nbsp;&nbsp;&nbsp;&nbsp; ☐ Acompanhar familiar<br>
☐ Outros: <input type="text" placeholder="Especificar motivo" style="width: 200px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Descrição:</strong><br>
<textarea placeholder="Descreva brevemente o quadro clínico..." style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>Período de afastamento:</strong><br>
De: <input type="date" style="border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit; padding: 2px 4px;"> 
até <input type="date" style="border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit; padding: 2px 4px;"><br><br>

<strong>CID-10:</strong> <input type="text" placeholder="Digite o CID ou descrição" data-cid="true" id="cidField" style="width: 350px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Observações:</strong><br>
☐ Deve evitar esforços físicos<br>
☐ Deve permanecer em repouso domiciliar<br>
☐ Apto para atividades leves<br>
☐ Outras: <input type="text" placeholder="Outras observações" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

Por ser verdade, firmo o presente.`
    },
    
    laudo: {
        title: 'Laudo Médico',
        content: `<center><strong>LAUDO MÉDICO</strong></center><br><br>

<strong>Data do Exame:</strong> <input type="date" style="border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit; padding: 2px 4px;"><br><br>

<strong>EXAME REALIZADO:</strong><br>
☐ Consulta clínica &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ☐ Avaliação cardiológica<br>
☐ Exame físico geral &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ☐ Avaliação neurológica<br>
☐ Outros: <input type="text" placeholder="Especificar exame" style="width: 200px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>INDICAÇÃO CLÍNICA:</strong><br>
<textarea placeholder="Motivo da solicitação do exame..." style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>MÉTODO/TÉCNICA:</strong><br>
<input type="text" placeholder="Método utilizado para o exame" style="width: 400px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>ACHADOS DO EXAME:</strong><br>
<strong>• Exame físico geral:</strong><br>
&nbsp;&nbsp;- Estado geral: <input type="text" placeholder="Bom, regular, etc." style="width: 150px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;- Pressão arterial: <input type="text" placeholder="120" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> x <input type="text" placeholder="80" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> mmHg<br>
&nbsp;&nbsp;- Frequência cardíaca: <input type="text" placeholder="72" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> bpm<br>
&nbsp;&nbsp;- Temperatura: <input type="text" placeholder="36.5" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> °C<br>
&nbsp;&nbsp;- Peso: <input type="text" placeholder="70" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> kg &nbsp;&nbsp;&nbsp; 
Altura: <input type="text" placeholder="170" style="width: 50px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> cm<br><br>

<strong>• Sistemas específicos:</strong><br>
&nbsp;&nbsp;- Cardiovascular: <input type="text" placeholder="Normal, sem alterações..." style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;- Respiratório: <input type="text" placeholder="Normal, sem alterações..." style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;- Abdome: <input type="text" placeholder="Plano, indolor..." style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br>
&nbsp;&nbsp;- Neurológico: <input type="text" placeholder="Sem déficits..." style="width: 300px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>CONCLUSÃO:</strong><br>
<textarea placeholder="Conclusão do exame e diagnóstico..." style="width: 100%; min-height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: inherit; resize: vertical;"></textarea><br>

<strong>CID-10:</strong> <input type="text" placeholder="Digite o CID ou descrição" data-cid="true" style="width: 350px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>RECOMENDAÇÕES:</strong><br>
☐ Manter acompanhamento médico regular<br>
☐ Retornar em <input type="text" placeholder="15" style="width: 30px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"> dias<br>
☐ Solicitar exames complementares<br>
☐ Outras: <input type="text" placeholder="Outras recomendações" style="width: 250px; border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit;"><br><br>

<strong>Próxima consulta:</strong> <input type="date" style="border: none; border-bottom: 1px solid #333; background: transparent; font-family: inherit; padding: 2px 4px;">`
    },
    
    livre: {
        title: 'Receituário Livre',
        content: ''
    }
};

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            await initializeCidSystem();
        });

        async function initializeApp() {
    // Check authentication and redirect admin
    const session = await checkSession();
    if (!session) {
        window.location.href = 'auth.html';
        return;
    }

    // Check if admin
    if (session.user.email === 'techne.br@gmail.com') {
        window.location.href = 'admin.html';
        return;
    }

    // Load user data
    await loadUserData(session.user.id);
    
    // Initialize components
    initializeDate();
    initializeSignature();
    
    // ✅ INICIALIZAR SISTEMA CID-10
    await initializeCidSystem();
    
    // ✅ ADICIONAR ESTILOS DE IMPRESSÃO
    addPrescriptionStyles();
    
    // Load default template
    loadTemplate('medicacao');
    
    // Set up auto-population for patient name
    setupAutoPopulation();
}

        // ========================================
        // SUBSCRIPTION CHECK
        // ========================================
       async function checkSubscriptionStatus(userId) {
    try {
        console.log('=== CHECKING SUBSCRIPTION STATUS ===');
        console.log('User ID:', userId);
        
        const { data: subscriptions, error } = await supabaseClient
            .from('subscriptions')
            .select('*')
            .eq('user_id', userId)
            .eq('status', 'active') // IMPORTANTE: Só pegar subscriptions ativas
            .order('created_at', { ascending: false })
            .limit(1);
            
        if (error) {
            console.error('Subscription check error:', error);
            return;
        }
        
        console.log('Subscriptions found:', subscriptions);
        
        // Pegar a subscription mais recente ATIVA
        const subscription = subscriptions?.[0];
        
        if (!subscription) {
            console.log('No active subscription found - creating trial or showing upgrade modal');
            // Se não tem subscription, pode ser um usuário novo sem trial criado
            // Vamos criar um trial ou mostrar modal de upgrade
            await createTrialIfNeeded(userId);
            return;
        }
        
        currentSubscription = subscription;
        console.log('Current subscription:', subscription);
        
        // Check if trial expired
        if (subscription.plan === 'trial' && subscription.trial_ends_at) {
            const trialEndString = subscription.trial_ends_at;
            console.log('Trial end string from DB:', trialEndString);
            
            // Parse the date properly
            const trialEnd = new Date(trialEndString);
            const now = new Date();
            
            console.log('Trial end date:', trialEnd.toISOString());
            console.log('Current date:', now.toISOString());
            console.log('Trial end timestamp:', trialEnd.getTime());
            console.log('Current timestamp:', now.getTime());
            
            const timeDiff = trialEnd.getTime() - now.getTime();
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            
            console.log('Time difference (ms):', timeDiff);
            console.log('Days left:', daysLeft);
            
            if (daysLeft < 0) {
                // Trial realmente expirou
                console.log('TRIAL EXPIRED! Days overdue:', Math.abs(daysLeft));
                showTrialExpiredModal();
                return;
            } else if (daysLeft === 0) {
                // Expira hoje
                console.log('TRIAL EXPIRES TODAY!');
                showToast('⚠️ Seu trial expira HOJE! Faça upgrade agora para não perder acesso.', 'warning');
            } else if (daysLeft <= 3) {
                // Expira em breve
                console.log('TRIAL EXPIRING SOON!');
                showToast(`⚠️ Seu trial expira em ${daysLeft} dia${daysLeft > 1 ? 's' : ''}! Faça upgrade para não perder acesso.`, 'warning');
            } else {
                console.log('Trial still valid for', daysLeft, 'days');
            }
        } else if (subscription.plan === 'essential') {
            console.log('User has essential plan - all good!');
        }
        
        // Check if subscription is past due or canceled
        if (subscription.status === 'past_due') {
            console.log('Subscription is PAST DUE');
            showTrialExpiredModal();
        } else if (subscription.status === 'canceled') {
            console.log('Subscription is CANCELED');
            showTrialExpiredModal();
        }
        
    } catch (error) {
        console.error('Subscription status error:', error);
    }
}

// Função auxiliar para criar trial se necessário
async function createTrialIfNeeded(userId) {
    try {
        // Verificar se já existe alguma subscription (mesmo inativa)
        const { data: allSubs } = await supabaseClient
            .from('subscriptions')
            .select('*')
            .eq('user_id', userId);
        
        if (!allSubs || allSubs.length === 0) {
            console.log('No subscription found at all - creating trial');
            
            // Criar trial de 30 dias
            const trialEndDate = new Date();
            trialEndDate.setDate(trialEndDate.getDate() + 30);
            
            const { error } = await supabaseClient
                .from('subscriptions')
                .insert({
                    user_id: userId,
                    plan: 'trial',
                    status: 'active',
                    trial_ends_at: trialEndDate.toISOString()
                });
            
            if (error) {
                console.error('Error creating trial:', error);
            } else {
                console.log('Trial created successfully');
                // Recarregar para pegar o novo trial
                await checkSubscriptionStatus(userId);
            }
        } else {
            console.log('User has inactive subscriptions - showing upgrade modal');
            showTrialExpiredModal();
        }
    } catch (error) {
        console.error('Error in createTrialIfNeeded:', error);
    }
}

function closeTrialModal() {
    const modal = document.getElementById('trialExpiredModal');
    if (modal) {
        modal.style.display = 'none';
    }
    // Still allow limited access - view only mode
    showToast('Modo de visualização. Faça upgrade para exportar e salvar.', 'warning');
    
    // Disable ALL export and print buttons
    document.querySelectorAll('.btn-primary').forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        if (btnText.includes('gerar') || 
            btnText.includes('salvar') || 
            btnText.includes('imprimir') || 
            btnText.includes('exportar')) {
            
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            
            // Remove onclick antigo e adiciona novo
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                showToast('⚠️ Recurso disponível apenas para assinantes', 'error');
                showTrialExpiredModal();
                return false;
            };
        }
    });
}

        function showTrialExpiredModal() {
            const modal = document.getElementById('trialExpiredModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeTrialModal() {
            const modal = document.getElementById('trialExpiredModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Still allow limited access - view only mode
            showToast('Modo de visualização. Faça upgrade para exportar e salvar.', 'warning');
            
            // Disable export buttons
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.textContent.includes('Gerar') || btn.textContent.includes('Salvar')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.onclick = () => {
                        showToast('Recurso disponível apenas para assinantes', 'error');
                        showTrialExpiredModal();
                    };
                }
            });
        }

        // ========================================
        // USER DATA MANAGEMENT
        // ========================================
        async function loadUserData(userId) {
            try {
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                currentUser = user;
                
                // Update UI with user data
                document.getElementById('userName').textContent = user.name || 'Usuário';
                document.getElementById('doctorName').textContent = user.name || 'Dr. Nome';
                document.getElementById('doctorCRM').textContent = `${user.council || 'CRM'}: ${user.registration_number || '00000'}-${user.state || 'UF'}`;
                document.getElementById('doctorSpecialty').textContent = user.specialty || 'Especialidade';
                document.getElementById('doctorPhone').textContent = user.phone ? `Tel: ${user.phone}` : '';
                
                // Add address if available
                if (user.address) {
                    document.getElementById('doctorAddress').textContent = user.address;
                    document.getElementById('doctorAddress').style.display = 'block';
                }
                
                // Update signature info
                document.getElementById('signatureName').textContent = user.name || 'Dr. Nome';
                document.getElementById('signatureCRM').textContent = `${user.council || 'CRM'}: ${user.registration_number || '00000'}-${user.state || 'UF'}`;
                
                // Load logo if exists
                if (user.logo_url) {
                    document.getElementById('logoPlaceholder').innerHTML = 
                        `<img src="${user.logo_url}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Logo">`;
                }

                // Load signature if exists
                if (user.signature_url) {
                    loadSignatureFromUrl(user.signature_url);
                }

                // Load subscription data
                await loadSubscriptionData(userId);

            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Erro ao carregar dados do usuário', 'error');
            }
        }

        async function loadSubscriptionData(userId) {
    try {
        const { data: subscription, error } = await supabaseClient
            .from('subscriptions')
            .select('*')
            .eq('user_id', userId)
            .eq('status', 'active')
            .single();

        const trialText = document.getElementById('trialText');
        
        if (error || !subscription) {
            trialText.textContent = 'Erro ao carregar plano';
            console.error('Subscription error:', error);
            return;
        }

        currentSubscription = subscription;
        
        if (subscription.plan === 'trial' && subscription.trial_ends_at) {
            const trialEnd = new Date(subscription.trial_ends_at);
            const now = new Date();
            const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
            
            if (daysLeft > 0) {
                trialText.textContent = `Teste: ${daysLeft}/30 dias restantes`;
                trialText.style.background = 'rgba(237, 137, 54, 0.2)';
                trialText.style.color = '#ed8936';
                
                // Avisar se restam poucos dias
                if (daysLeft <= 3) {
                    trialText.style.background = 'rgba(245, 101, 101, 0.2)';
                    trialText.style.color = '#f56565';
                }
            } else {
                trialText.textContent = 'Trial Expirado';
                trialText.style.background = 'rgba(245, 101, 101, 0.2)';
                trialText.style.color = '#f56565';
            }
            
        } else if (subscription.plan === 'essential') {
            trialText.textContent = 'Plano: Essencial';
            trialText.style.background = 'rgba(72, 187, 120, 0.2)';
            trialText.style.color = '#48bb78';
            
        } else {
            trialText.textContent = 'Plano não identificado';
            trialText.style.background = 'rgba(156, 163, 175, 0.2)';
            trialText.style.color = '#6b7280';
        }

    } catch (error) {
        console.error('Error loading subscription data:', error);
        document.getElementById('trialText').textContent = 'Erro ao carregar plano';
    }
}

        // ========================================
        // TEMPLATE MANAGEMENT
        // ========================================
        function selectTemplate(templateName) {
    loadTemplate(templateName);
    
    // Save preference
    if (window.localStorage) {
        localStorage.setItem('lastTemplate', templateName);
    }
}
        function syncTextareaFromDiv() {
    const contentDisplay = document.getElementById('prescriptionDisplay');
    const textarea = document.getElementById('prescriptionText');
    
    // Extrair texto dos inputs e textareas para sincronizar
    let content = contentDisplay.innerHTML;
    
    // Capturar valores dos inputs
    const inputs = contentDisplay.querySelectorAll('input');
    inputs.forEach(input => {
        if (input.value) {
            content = content.replace(input.outerHTML, input.value);
        }
    });
    
    // Capturar valores dos textareas
    const textareas = contentDisplay.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        if (textarea.value) {
            content = content.replace(textarea.outerHTML, textarea.value);
        }
    });
    
    textarea.value = content;
}
function syncTextareaFromDiv() {
    const contentDisplay = document.getElementById('prescriptionDisplay');
    const textarea = document.getElementById('prescriptionText');
    
    // Extrair texto dos inputs e textareas para sincronizar
    let content = contentDisplay.innerHTML;
    
    // Capturar valores dos inputs
    const inputs = contentDisplay.querySelectorAll('input');
    inputs.forEach(input => {
        if (input.value) {
            content = content.replace(input.outerHTML, input.value);
        }
    });
    
    // Capturar valores dos textareas
    const textareas = contentDisplay.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        if (textarea.value) {
            content = content.replace(textarea.outerHTML, textarea.value);
        }
    });
    
    textarea.value = content;
}


        // ========================================
        // FORM UPDATES
        // ========================================
        function updatePatientDisplay() {
            const patientName = document.getElementById('patientName').value;
            document.getElementById('patientDisplay').textContent = 
                patientName || '_________________________';
        }

        function updateDateDisplay() {
            const dateInput = document.getElementById('prescriptionDate').value;
            if (dateInput) {
                const date = new Date(dateInput + 'T00:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                document.getElementById('dateDisplay').textContent = `${day}/${month}/${year}`;
            } else {
                document.getElementById('dateDisplay').textContent = '__/__/____';
            }
        }

        function initializeDate() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('prescriptionDate').value = dateString;
            updateDateDisplay();
        }

        // ========================================
        // SIGNATURE MANAGEMENT
        // ========================================
        function initializeSignature() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';
            signatureCtx.lineWidth = 2;
            signatureCtx.strokeStyle = '#000000';
            
            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            signatureCanvas.addEventListener('touchstart', handleTouch);
            signatureCanvas.addEventListener('touchmove', handleTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            updateSignaturePreview();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(
                e.type === 'touchstart' ? 'mousedown' : 
                e.type === 'touchmove' ? 'mousemove' : 'mouseup',
                {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }
            );
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            const preview = document.getElementById('signaturePreview');
            if (preview) {
                const previewCtx = preview.getContext('2d');
                previewCtx.clearRect(0, 0, preview.width, preview.height);
                preview.style.display = 'none';
            }
        }

        function handleSignatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 1024 * 1024) {
                showToast('Arquivo muito grande. Máximo 1MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    clearSignature();
                    const scale = Math.min(
                        signatureCanvas.width / img.width,
                        signatureCanvas.height / img.height
                    );
                    const width = img.width * scale;
                    const height = img.height * scale;
                    const x = (signatureCanvas.width - width) / 2;
                    const y = (signatureCanvas.height - height) / 2;
                    
                    signatureCtx.drawImage(img, x, y, width, height);
                    updateSignaturePreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadSignatureFromUrl(url) {
            const img = new Image();
            img.onload = () => {
                clearSignature();
                signatureCtx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                updateSignaturePreview();
            };
            img.src = url;
        }

        function updateSignaturePreview() {
            const preview = document.getElementById('signaturePreview');
            if (preview && hasSignature()) {
                const previewCtx = preview.getContext('2d');
                previewCtx.clearRect(0, 0, preview.width, preview.height);
                previewCtx.drawImage(signatureCanvas, 0, 0, preview.width, preview.height);
                preview.style.display = 'block';
            }
        }

        function hasSignature() {
            const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            return imageData.data.some(channel => channel !== 0);
        }

        // ========================================
        // EXPORT FUNCTIONS
        // ========================================
        // ========================================
// CORREÇÃO DA FUNÇÃO generatePDF() NO APP.HTML
// ========================================

async function generatePDF() {
    try {
        showToast('Gerando PDF...', 'info');
        
        const element = document.getElementById('prescriptionPreview');
        
        // Configurações otimizadas para PDF
        const canvas = await html2canvas(element, {
            scale: 1.5, // ✅ Reduzido de 2 para 1.5
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            width: element.offsetWidth,
            height: element.offsetHeight,
            scrollX: 0,
            scrollY: 0
        });
        
        // Criar PDF em formato A4
        const pdf = new window.jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        // Dimensões A4 em mm
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 10; // Margens de 10mm
        
        // Calcular dimensões da imagem
        const imgWidth = pageWidth - (margin * 2); // 190mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // ✅ VERIFICAR SE CABE NA PÁGINA E AJUSTAR SE NECESSÁRIO
        const maxHeight = pageHeight - (margin * 2); // 277mm
        
        let finalWidth = imgWidth;
        let finalHeight = imgHeight;
        
        if (imgHeight > maxHeight) {
            // Se a altura for maior que o máximo, reduzir proporcionalmente
            finalHeight = maxHeight;
            finalWidth = (canvas.width * finalHeight) / canvas.height;
        }
        
        // Centralizar na página
        const xPos = (pageWidth - finalWidth) / 2;
        const yPos = margin;
        
        // Converter canvas para imagem e adicionar ao PDF
        const imgData = canvas.toDataURL('image/png', 0.95);
        pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);
        
        // Salvar PDF
        const fileName = generateFileName('pdf');
        pdf.save(fileName);
        
        showToast('PDF gerado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Erro ao gerar PDF', 'error');
    }
}

// ========================================
// FUNÇÃO MELHORADA PARA generatePNG()
// ========================================

async function generatePNG() {
    try {
        showToast('Gerando imagem...', 'info');
        
        const element = document.getElementById('prescriptionPreview');
        
        const canvas = await html2canvas(element, {
            scale: 2, // Manter qualidade alta para PNG
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });
        
        // Criar link de download
        const link = document.createElement('a');
        link.download = generateFileName('png');
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showToast('Imagem gerada com sucesso!', 'success');
        
    } catch (error) {
        console.error('Error generating PNG:', error);
        showToast('Erro ao gerar imagem', 'error');
    }
}

// ========================================
// CSS ADICIONAL PARA MELHORAR IMPRESSÃO
// ========================================

const additionalPrintCSS = `
<style id="prescription-print-styles">
    @media print, screen {
        .prescription-preview {
            width: 210mm !important;
            min-height: auto !important;
            max-height: 297mm !important;
            padding: 20mm !important;
            margin: 0 !important;
            box-shadow: none !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            overflow: hidden !important;
        }
        
        .prescription-preview input {
            border: none !important;
            border-bottom: 1px solid #333 !important;
            background: transparent !important;
            font-size: 11px !important;
            padding: 2px 0 !important;
        }
        
        .prescription-preview textarea {
            border: 1px solid #666 !important;
            font-size: 11px !important;
            padding: 4px !important;
            min-height: auto !important;
        }
        
        .prescription-header {
            margin-bottom: 15px !important;
            padding: 15px !important;
        }
        
        .patient-info {
            margin-bottom: 15px !important;
            padding: 10px !important;
        }
        
        .prescription-content {
            min-height: auto !important;
            margin-bottom: 20px !important;
        }
        
        .signature-section {
            margin-top: 30px !important;
        }
        
        .signature-canvas {
            border: 1px solid #333 !important;
        }
    }
</style>
`;

// ========================================
// ADICIONAR CSS QUANDO A PÁGINA CARREGA
// ========================================

function addPrescriptionStyles() {
    if (!document.getElementById('prescription-print-styles')) {
        document.head.insertAdjacentHTML('beforeend', additionalPrintCSS);
    }
}

        async function savePrescription() {
            try {
                const patientName = document.getElementById('patientName').value;
                const content = document.getElementById('prescriptionTextDisplay').innerText;
                
                if (!patientName.trim()) {
                    showToast('Por favor, preencha o nome do paciente', 'error');
                    return;
                }
                
                if (!content.trim() || content === 'Digite aqui o conteúdo do receituário...') {
                    showToast('Por favor, preencha o conteúdo do receituário', 'error');
                    return;
                }
                
                showToast('Salvando receituário...', 'info');
                
                const prescriptionData = {
                    patientName: patientName,
                    content: content,
                    template: currentTemplate,
                    signature: hasSignature() ? signatureCanvas.toDataURL() : null,
                    date: document.getElementById('prescriptionDate').value
                };
                
                const result = await savePrescriptionToDatabase(prescriptionData);
                
                if (result.success) {
                    showToast('Receituário salvo com sucesso!', 'success');
                } else {
                    showToast(result.error || 'Erro ao salvar receituário', 'error');
                }
                
            } catch (error) {
                console.error('Error saving prescription:', error);
                showToast('Erro ao salvar receituário', 'error');
            }
        }

        async function savePrescriptionToDatabase(prescriptionData) {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Usuário não autenticado');

                const { data, error } = await supabaseClient
                    .from('prescriptions')
                    .insert({
                        user_id: user.id,
                        patient_name: prescriptionData.patientName,
                        content: prescriptionData.content,
                        template_type: prescriptionData.template,
                        signature_data: prescriptionData.signature,
                        prescription_date: prescriptionData.date
                    })
                    .select()
                    .single();

                if (error) throw error;

                return { success: true, data };

            } catch (error) {
                console.error('Save prescription error:', error);
                return { success: false, error: error.message };
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function generateFileName(extension) {
            const patientName = document.getElementById('patientName').value || 'Paciente';
            const date = document.getElementById('prescriptionDate').value || new Date().toISOString().slice(0, 10);
            const safeName = patientName.replace(/[^a-z0-9]/gi, '_');
            const safeDate = date.replace(/-/g, '');
            
            return `Receituario_${safeName}_${safeDate}.${extension}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'auth.html';
            }
        }

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            return session;
        }
    function showUpgradeModal() {
    // Fechar modal de trial expirado
    document.getElementById('trialExpiredModal').style.display = 'none';
    // Abrir modal de escolha de plano
    document.getElementById('planChoiceModal').style.display = 'flex';
}

function closePlanModal() {
    document.getElementById('planChoiceModal').style.display = 'none';
}

function goToStripeCheckout(plan) {
    // Links do Stripe
    const STRIPE_LINKS = {
        monthly: 'https://buy.stripe.com/bJeaEYaht4mV5zC8pJ00000',
        yearly: 'https://buy.stripe.com/7sY8wQcpBcTrbY0cFZ00001'
    };
    
    const link = plan === 'yearly' ? STRIPE_LINKS.yearly : STRIPE_LINKS.monthly;
    
    // Adicionar email e user_id se disponível
    if (currentUser) {
        const checkoutUrl = `${link}?prefilled_email=${encodeURIComponent(currentUser.email)}&client_reference_id=${currentUser.id}`;
        window.location.href = checkoutUrl;
    } else {
        window.location.href = link;
    }
}
    async function searchCID10(searchTerm) {
            try {
                // Limpar e formatar o termo de busca
                const cleanTerm = searchTerm.trim().toUpperCase().replace(/\./g, '');
                
                // Usar a função SQL que criamos
                const { data, error } = await supabaseClient
                    .rpc('search_cid10', { search_term: searchTerm });
                
                if (error) throw error;
                
                const resultsDiv = document.getElementById('cidResults');
                
                if (!data || data.length === 0) {
                    // Tentar busca direta se a função não retornar resultados
                    const { data: directData, error: directError } = await supabaseClient
                        .from('cid10_subcategorias')
                        .select('subcat, descricao, descrabrev')
                        .or(`subcat.ilike.${cleanTerm}%,descricao.ilike.%${searchTerm}%,descrabrev.ilike.%${searchTerm}%`)
                        .not('subcat', 'is', null)
                        .neq('subcat', '')
                        .limit(20);
                    
                    if (!directData || directData.length === 0) {
                        resultsDiv.innerHTML = '<div class="cid-no-results">Nenhum resultado encontrado</div>';
                        return;
                    }
                    
                    // Formatar e mostrar resultados da busca direta
                    resultsDiv.innerHTML = directData.map(item => {
                        // Formatar código com ponto (A00.0)
                        let formattedCode = item.subcat;
                        if (item.subcat.length === 4) {
                            formattedCode = item.subcat.substring(0, 3) + '.' + item.subcat.substring(3);
                        }
                        
                        const description = item.descricao || item.descrabrev || 'Sem descrição';
                        
                        return `
                            <div class="cid-result-item" onclick="selectCID('${formattedCode}', '${description.replace(/'/g, "\\'")}')">
                                <div class="cid-result-code">${formattedCode}</div>
                                <div class="cid-result-desc">${description}</div>
                            </div>
                        `;
                    }).join('');
                    
                } else {
                    // Mostrar resultados da função RPC
                    resultsDiv.innerHTML = data.map(item => `
                        <div class="cid-result-item" onclick="selectCID('${item.codigo}', '${item.descricao.replace(/'/g, "\\'")}')">
                            <div class="cid-result-code">${item.codigo}</div>
                            <div class="cid-result-desc">${item.descricao}</div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Erro ao buscar CID-10:', error);
                
                // Busca de fallback mais simples
                try {
                    const resultsDiv = document.getElementById('cidResults');
                    
                    // Tentar busca básica
                    const searchTermUpper = searchTerm.toUpperCase().replace(/\./g, '');
                    
                    const { data, error: fallbackError } = await supabaseClient
                        .from('cid10_view') // Usar a view se existir
                        .select('codigo, descricao')
                        .or(`codigo.ilike.${searchTerm}%,descricao.ilike.%${searchTerm}%`)
                        .limit(20);
                    
                    if (fallbackError) {
                        // Se a view não existir, usar a tabela diretamente
                        const { data: tableData, error: tableError } = await supabaseClient
                            .from('cid10_subcategorias')
                            .select('subcat, descricao')
                            .or(`subcat.ilike.${searchTermUpper}%,descricao.ilike.%${searchTerm}%`)
                            .not('subcat', 'is', null)
                            .neq('subcat', '')
                            .limit(20);
                        
                        if (tableError) throw tableError;
                        
                        if (!tableData || tableData.length === 0) {
                            resultsDiv.innerHTML = '<div class="cid-no-results">Nenhum resultado encontrado</div>';
                            return;
                        }
                        
                        resultsDiv.innerHTML = tableData.map(item => {
                            let formattedCode = item.subcat;
                            if (item.subcat.length === 4) {
                                formattedCode = item.subcat.substring(0, 3) + '.' + item.subcat.substring(3);
                            }
                            
                            return `
                                <div class="cid-result-item" onclick="selectCID('${formattedCode}', '${(item.descricao || '').replace(/'/g, "\\'")}')">
                                    <div class="cid-result-code">${formattedCode}</div>
                                    <div class="cid-result-desc">${item.descricao || 'Sem descrição'}</div>
                                </div>
                            `;
                        }).join('');
                        
                    } else {
                        if (!data || data.length === 0) {
                            resultsDiv.innerHTML = '<div class="cid-no-results">Nenhum resultado encontrado</div>';
                            return;
                        }
                        
                        resultsDiv.innerHTML = data.map(item => `
                            <div class="cid-result-item" onclick="selectCID('${item.codigo}', '${(item.descricao || '').replace(/'/g, "\\'")}')">
                                <div class="cid-result-code">${item.codigo}</div>
                                <div class="cid-result-desc">${item.descricao}</div>
                            </div>
                        `).join('');
                    }
                    
                } catch (fallbackError) {
                    console.error('Erro na busca alternativa:', fallbackError);
                    document.getElementById('cidResults').innerHTML = 
                        '<div class="cid-no-results">Erro ao buscar. Verifique se os dados foram importados.</div>';
                }
            }
        }
        async function loadCidData() {
    try {
        console.log('Carregando dados CID-10...');
        
        const { data, error } = await supabaseClient
            .from('cid10_subcategorias')
            .select('SUBCAT, DESCRICAO, DESCRABREV')
            .order('SUBCAT')
            .limit(1000); // Carregar primeiros 1000 para performance
            
        if (error) {
            console.error('Erro ao carregar CID-10:', error);
            return;
        }
        
        cidData = data.map(item => ({
            code: item.SUBCAT || '',
            description: item.DESCRICAO || '',
            shortDesc: item.DESCRABREV || ''
        })).filter(item => item.code && item.description);
        
        console.log(`${cidData.length} códigos CID-10 carregados`);
        
    } catch (error) {
        console.error('Erro ao carregar dados CID-10:', error);
    }
}
function createCidAutocomplete(inputElement) {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.display = 'inline-block';
    container.style.width = '100%';
    
    // Substituir input original
    inputElement.parentNode.insertBefore(container, inputElement);
    container.appendChild(inputElement);
    
    // Criar lista de sugestões
    const suggestionsList = document.createElement('div');
    suggestionsList.className = 'cid-suggestions';
    suggestionsList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    container.appendChild(suggestionsList);
    
    // Event listeners
    inputElement.addEventListener('input', (e) => handleCidInput(e, suggestionsList));
    inputElement.addEventListener('focus', (e) => handleCidInput(e, suggestionsList));
    inputElement.addEventListener('blur', () => {
        // Delay para permitir clique nas sugestões
        setTimeout(() => {
            suggestionsList.style.display = 'none';
        }, 200);
    });
    
    return container;
}

function handleCidInput(event, suggestionsList) {
    const query = event.target.value.trim();
    currentCidInput = event.target;
    
    if (query.length < 2) {
        suggestionsList.style.display = 'none';
        return;
    }
    
    // Buscar CIDs que correspondem
    const matches = cidData.filter(cid => {
        const lowerQuery = query.toLowerCase();
        return cid.code.toLowerCase().includes(lowerQuery) ||
               cid.description.toLowerCase().includes(lowerQuery) ||
               cid.shortDesc.toLowerCase().includes(lowerQuery);
    }).slice(0, 8); // Mostrar máximo 8 resultados
    
    if (matches.length === 0) {
        suggestionsList.style.display = 'none';
        return;
    }
    
    // Renderizar sugestões
    suggestionsList.innerHTML = matches.map(cid => `
        <div class="cid-suggestion" onclick="selectCid('${cid.code}', '${cid.description.replace(/'/g, "\\'")}')">
            <strong>${cid.code}</strong>
            <br>
            <small>${cid.description}</small>
        </div>
    `).join('');
    
    suggestionsList.style.display = 'block';
}

function selectCid(code, description) {
    if (currentCidInput) {
        // Preencher o campo atual
        currentCidInput.value = `${code} - ${description}`;
        
        // Auto-popular outros campos CID no template
        populateAllCidFields(code, description);
    }
    
    // Fechar sugestões
    document.querySelectorAll('.cid-suggestions').forEach(list => {
        list.style.display = 'none';
    });
}

function populateAllCidFields(code, description) {
    // Encontrar todos os campos que podem ter CID
    const cidFields = document.querySelectorAll('input[placeholder*="CID"], input[id*="cid"], input[name*="cid"]');
    
    cidFields.forEach(field => {
        if (field !== currentCidInput) {
            field.value = `${code} - ${description}`;
        }
    });
    
    // Para templates específicos, popular campos específicos
    const currentTemplate = getCurrentTemplate();
    if (currentTemplate === 'atestado') {
        const cidField = document.querySelector('#cidField, input[placeholder*="CID-10"]');
        if (cidField && cidField !== currentCidInput) {
            cidField.value = code;
        }
    }
}
// ========================================
// CSS PARA SUGESTÕES CID
// ========================================

function addCidStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .cid-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }
        
        .cid-suggestion:hover {
            background-color: #f8fafc;
        }
        
        .cid-suggestion:last-child {
            border-bottom: none;
        }
        
        .cid-suggestion strong {
            color: var(--primary);
            font-size: 14px;
        }
        
        .cid-suggestion small {
            color: var(--text-light);
            font-size: 12px;
            line-height: 1.4;
            display: block;
            margin-top: 4px;
        }
        
        .cid-suggestions {
            font-family: inherit;
        }
    `;
    
    document.head.appendChild(style);
}

// ========================================
// INICIALIZAR SISTEMA CID-10
// ========================================

async function initializeCidSystem() {
    // Carregar dados CID-10
    await loadCidData();
    
    // Adicionar estilos
    addCidStyles();
    
    // Procurar campos CID existentes e adicionar autocomplete
    setTimeout(() => {
        const cidInputs = document.querySelectorAll('input[placeholder*="CID"], [data-cid="true"]');
        cidInputs.forEach(input => {
            createCidAutocomplete(input);
        });
    }, 1000);
}

function getCurrentTemplate() {
    return currentTemplate || 'livre';
}
    </script>
</body>
</html>