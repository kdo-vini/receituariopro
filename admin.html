<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - Receituário Pro</title>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-dark: #1a202c;
            --text-light: #718096;
            --gray-light: #f7fafc;
            --white: #ffffff;
            --success: #48bb78;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-light);
            min-height: 100vh;
        }

        /* Loading */
        .loading-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--gradient);
            display: flex; align-items: center; justify-content: center;
            color: white; z-index: 1000;
            transition: opacity 0.3s;
        }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }

        .dashboard { display: none; }
        .dashboard.active { display: block; }

        /* Header */
        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-logo { display: flex; align-items: center; gap: 0.75rem; }
        .admin-logo img { height: 32px; }
        .admin-logo span { font-weight: 700; font-size: 1.25rem; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .admin-user { display: flex; align-items: center; gap: 1rem; }
        .btn-logout { padding: 0.5rem 1rem; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; }

        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-dark); margin-bottom: 2rem; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-title { font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 2rem; }
        .chart-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark); }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div>Carregando...</div>
    </div>

    <div class="dashboard" id="dashboard">
        <header class="admin-header">
            <div class="admin-logo">
                <img src="img/saas-logo.png" alt="Logo">
                <span>Receituário Pro</span>
            </div>
            <div class="admin-user">
                <span id="adminName"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </header>

        <main class="main-content">
            <h1 class="page-title">Relatório Geral</h1>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Novos usuários (mês)</div>
                    <div class="stat-value" id="newUsers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Trials ativos</div>
                    <div class="stat-value" id="trialUsers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Assinaturas ativas</div>
                    <div class="stat-value" id="activeUsers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Mensal / Anual</div>
                    <div class="stat-value"><span id="monthlySubs">0</span> / <span id="yearlySubs">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Receita mensal</div>
                    <div class="stat-value" id="monthlyRevenue">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Receita projetada</div>
                    <div class="stat-value" id="projectedRevenue">R$ 0,00</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h2>Novos usuários por mês</h2>
                    <canvas id="usersChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Distribuição de planos</h2>
                    <canvas id="planChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Projeção de receita</h2>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        const MONTH_NAMES = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'auth.html'; return; }

            const { data: user, error } = await supabaseClient
                .from('users')
                .select('name,is_admin')
                .eq('id', session.user.id)
                .single();

            if (error || !user?.is_admin) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('adminName').textContent = user.name || 'Admin';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('loadingScreen').classList.add('hidden');

            await loadDashboardData();
        }

        async function loadDashboardData() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            const [newUsersRes, trialRes, activeRes, usersYearRes] = await Promise.all([
                supabaseClient.from('users').select('*', { count:'exact', head:true }).gte('created_at', startOfMonth.toISOString()),
                supabaseClient.from('subscriptions').select('*', { count:'exact', head:true }).eq('plan','trial').eq('status','active'),
                supabaseClient.from('subscriptions').select('*').eq('plan','essential').eq('status','active'),
                supabaseClient.from('users').select('id,created_at').gte('created_at', startOfYear.toISOString())
            ]);

            const newUsers = newUsersRes.count || 0;
            const trialCount = trialRes.count || 0;
            const activeSubs = activeRes.data || [];
            const usersYear = usersYearRes.data || [];

            let monthlyCount = 0; let yearlyCount = 0;
            activeSubs.forEach(s => {
                const start = new Date(s.current_period_start);
                const end = new Date(s.current_period_end);
                const diffMonths = (end - start) / (1000*60*60*24*30);
                if (diffMonths > 1.5) yearlyCount++; else monthlyCount++;
            });
            const activeCount = activeSubs.length;

            const mrr = monthlyCount * 29 + yearlyCount * (348/12);
            const monthsRemaining = 12 - now.getMonth();
            const projected = mrr * monthsRemaining;

            document.getElementById('newUsers').textContent = newUsers;
            document.getElementById('trialUsers').textContent = trialCount;
            document.getElementById('activeUsers').textContent = activeCount;
            document.getElementById('monthlySubs').textContent = monthlyCount;
            document.getElementById('yearlySubs').textContent = yearlyCount;
            document.getElementById('monthlyRevenue').textContent = `R$ ${mrr.toFixed(2)}`;
            document.getElementById('projectedRevenue').textContent = `R$ ${projected.toFixed(2)}`;

            // Users per month chart
            const usersPerMonth = new Array(12).fill(0);
            usersYear.forEach(u => { usersPerMonth[new Date(u.created_at).getMonth()]++; });
            const ctxUsers = document.getElementById('usersChart').getContext('2d');
            new Chart(ctxUsers, {
                type: 'bar',
                data: { labels: MONTH_NAMES, datasets: [{ label: 'Usuários', data: usersPerMonth, backgroundColor: '#667eea' }] },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Plan distribution chart
            const ctxPlan = document.getElementById('planChart').getContext('2d');
            new Chart(ctxPlan, {
                type: 'doughnut',
                data: { labels: ['Mensal','Anual'], datasets: [{ data: [monthlyCount, yearlyCount], backgroundColor: ['#764ba2','#667eea'] }] }
            });

            // Revenue projection chart
            const projLabels = MONTH_NAMES.slice(now.getMonth());
            const projData = new Array(projLabels.length).fill(mrr.toFixed(2));
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctxRev, {
                type: 'line',
                data: { labels: projLabels, datasets: [{ label: 'Receita projetada', data: projData, borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.2)', tension: 0.2 }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
