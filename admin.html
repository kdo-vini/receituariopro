<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - Receitu√°rio Pro</title>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-dark: #1a202c;
            --text-light: #718096;
            --gray-light: #f7fafc;
            --white: #ffffff;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #e53e3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-light);
            min-height: 100vh;
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .loading-screen.hidden { opacity: 0; pointer-events: none; }

        .dashboard { display: none; }
        .dashboard.active { display: block; }

        /* Header */
        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-logo { display: flex; align-items: center; gap: 0.75rem; }
        .admin-logo img { height: 32px; }
        .admin-logo span { font-weight: 700; font-size: 1.25rem; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .admin-user { display: flex; align-items: center; gap: 1rem; }
        .btn-logout { padding: 0.5rem 1rem; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; }

        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-dark); margin-bottom: 2rem; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
        .stat-title { font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        .stat-icon { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; opacity: 0.2; }
        .stat-change { font-size: 0.8rem; color: var(--text-light); }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 2rem; margin-bottom: 2rem; }
        .chart-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark); }

        /* Users table */
        .filters { display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap; }
        .filters input, .filters select { padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 8px; }
        .filters button { padding: 0.5rem 1rem; border: none; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; text-align: left; }

        .status-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: white; }
        .status-active { background: var(--success); }
        .status-trial { background: var(--warning); color: black; }
        .status-canceled { background: var(--danger); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 300px; display: flex; flex-direction: column; gap: 1rem; }
        .modal.hidden { display: none; }
        .modal-content button { padding: 0.5rem 1rem; border: none; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; }

        /* Toast */
        #toastContainer { position: fixed; bottom: 1rem; right: 1rem; z-index: 1100; }
        .toast { background: var(--secondary); color: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; opacity: 0; transform: translateY(20px); transition: all 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }

        body.refreshing .stat-value { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div>Carregando...</div>
    </div>

    <div class="dashboard" id="dashboard">
        <header class="admin-header">
            <div class="admin-logo">
                <img src="img/logo.png" alt="Logo">
                <span>Receitu√°rio Pro</span>
            </div>
            <div class="admin-user">
                <span id="adminName"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </header>

        <main class="main-content">
            <h1 class="page-title">Relat√≥rio Geral</h1>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-icon">üë•</span>
                    <div class="stat-title">Novos usu√°rios (m√™s)</div>
                    <div class="stat-value" id="newUsers">0</div>
                    <div class="stat-change" id="newUsersChange">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üß™</span>
                    <div class="stat-title">Trials ativos</div>
                    <div class="stat-value" id="trialUsers">0</div>
                    <div class="stat-change" id="trialUsersChange">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚úÖ</span>
                    <div class="stat-title">Assinaturas ativas</div>
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-change" id="activeUsersChange">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üìÖ</span>
                    <div class="stat-title">Mensal / Anual</div>
                    <div class="stat-value"><span id="monthlySubs">0</span> / <span id="yearlySubs">0</span></div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üîÅ</span>
                    <div class="stat-title">Churn rate</div>
                    <div class="stat-value" id="churnRate">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üè∑</span>
                    <div class="stat-title">LTV m√©dio</div>
                    <div class="stat-value" id="ltv">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üéØ</span>
                    <div class="stat-title">CAC estimado</div>
                    <div class="stat-value" id="cac">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚û°Ô∏è</span>
                    <div class="stat-title">Convers√£o Trial ‚Üí Pago</div>
                    <div class="stat-value" id="conversionRate">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üí∞</span>
                    <div class="stat-title">Receita mensal</div>
                    <div class="stat-value" id="monthlyRevenue">R$ 0,00</div>
                    <div class="stat-change" id="monthlyRevenueChange">0%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üìà</span>
                    <div class="stat-title">Receita projetada</div>
                    <div class="stat-value" id="projectedRevenue">R$ 0,00</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h2>Novos usu√°rios por m√™s</h2>
                    <canvas id="usersChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Distribui√ß√£o de planos</h2>
                    <canvas id="planChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Receita realizada x projetada</h2>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <section class="user-section">
                <h2>Profissionais</h2>
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="Buscar...">
                    <select id="filterStatus">
                        <option value="">Todos status</option>
                        <option value="active">Ativo</option>
                        <option value="trial">Trial</option>
                        <option value="canceled">Cancelado</option>
                    </select>
                    <select id="filterPlan">
                        <option value="">Todos planos</option>
                        <option value="monthly">Mensal</option>
                        <option value="yearly">Anual</option>
                        <option value="trial">Trial</option>
                    </select>
                    <select id="filterSpecialty">
                        <option value="">Todas especialidades</option>
                    </select>
                    <button onclick="exportCSV()">Exportar CSV</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Plano</th>
                            <th>Especialidade</th>
                            <th>√öltimo login</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </section>
        </main>
    </div>

    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalName"></h3>
            <button onclick="sendEmail()">Enviar e-mail</button>
            <button onclick="resetPassword()">Resetar senha</button>
            <button onclick="closeUserModal()">Fechar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="js/supabase-config.js"></script>
    <script>
        const MONTH_NAMES = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        let usersData = [];
        const usersCharts = {};

        function isMonthly(plan) {
            return (plan || '').toLowerCase().includes('month') || (plan || '').toLowerCase().includes('mensal');
        }

        function isYearly(plan) {
            return (plan || '').toLowerCase().includes('year') || (plan || '').toLowerCase().includes('anual');
        }

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'auth.html'; return; }

            const { data: user, error } = await supabaseClient
                .from('users')
                .select('name,is_admin')
                .eq('id', session.user.id)
                .single();

            if (error || !user?.is_admin) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('adminName').textContent = user.name || 'Admin';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('loadingScreen').classList.add('hidden');

            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            document.getElementById('filterPlan').addEventListener('change', applyFilters);
            document.getElementById('filterSpecialty').addEventListener('change', applyFilters);

            await Promise.all([loadDashboardData(), loadUsers()]);
            setupRealtime();
            setInterval(() => { loadDashboardData(); loadUsers(); }, 60000);
        }

        async function loadDashboardData() {
            document.body.classList.add('refreshing');
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const prevStartOfMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            const [
                newUsersRes, prevNewUsersRes,
                trialRes, prevTrialRes,
                activeRes, prevActiveRes,
                cancelRes, marketingRes,
                paymentsYearRes, newPaidThisMonthRes,
                usersYearRes
            ] = await Promise.all([
                supabaseClient.from('users').select('*', { count:'exact', head:true }).gte('created_at', startOfMonth.toISOString()),
                supabaseClient.from('users').select('*', { count:'exact', head:true }).gte('created_at', prevStartOfMonth.toISOString()).lt('created_at', startOfMonth.toISOString()),
                supabaseClient.from('subscriptions').select('*', { count:'exact', head:true }).eq('plan','trial').eq('status','active'),
                supabaseClient.from('subscriptions').select('*', { count:'exact', head:true }).eq('plan','trial').eq('status','active').lt('created_at', startOfMonth.toISOString()),
                supabaseClient.from('subscriptions').select('plan,status').eq('status','active').neq('plan','trial'),
                supabaseClient.from('subscriptions').select('plan,status').eq('status','active').neq('plan','trial').lt('created_at', startOfMonth.toISOString()),
                supabaseClient.from('subscriptions').select('*', { count:'exact', head:true }).eq('status','canceled').gte('canceled_at', startOfMonth.toISOString()),
                supabaseClient.from('marketing_costs').select('amount').eq('month', now.getMonth()+1).eq('year', now.getFullYear()).single(),
                supabaseClient.from('payments').select('amount,paid_at').gte('paid_at', startOfYear.toISOString()),
                supabaseClient.from('subscriptions').select('*', { count:'exact', head:true }).eq('status','active').neq('plan','trial').gte('created_at', startOfMonth.toISOString()),
                supabaseClient.from('users').select('id,created_at').gte('created_at', startOfYear.toISOString())
            ]);

            const newUsers = newUsersRes.count || 0;
            const prevNewUsers = prevNewUsersRes.count || 0;
            const trialCount = trialRes.count || 0;
            const prevTrialCount = prevTrialRes.count || 0;
            const activeSubs = activeRes.data || [];
            const prevActiveSubs = prevActiveRes.data || [];
            const cancellations = cancelRes.count || 0;
            const marketingCost = marketingRes.data?.amount || 0;
            const paymentsYear = paymentsYearRes.data || [];
            const newPaidThisMonth = newPaidThisMonthRes.count || 0;
            const usersYear = usersYearRes.data || [];

            const planCounts = {};
            activeSubs.forEach(s => { const key = s.plan || 'unknown'; planCounts[key] = (planCounts[key]||0)+1; });
            const monthlyCount = activeSubs.filter(s => isMonthly(s.plan)).length;
            const yearlyCount = activeSubs.filter(s => isYearly(s.plan)).length;
            const activeCount = activeSubs.length;

            const prevMonthlyCount = prevActiveSubs.filter(s => isMonthly(s.plan)).length;
            const prevYearlyCount = prevActiveSubs.filter(s => isYearly(s.plan)).length;
            const prevActiveCount = prevActiveSubs.length;

            const mrr = monthlyCount * 29 + yearlyCount * (348/12);
            const monthlyRevenue = paymentsYear.filter(p => new Date(p.paid_at).getMonth() === now.getMonth()).reduce((sum,p) => sum + p.amount, 0);
            const prevMonthlyRevenue = paymentsYear.filter(p => new Date(p.paid_at).getMonth() === now.getMonth()-1).reduce((sum,p) => sum + p.amount, 0);
            const realizedRevenue = paymentsYear.reduce((sum,p) => sum + p.amount, 0);
            const monthsRemaining = 11 - now.getMonth();
            const projected = realizedRevenue + monthlyRevenue * monthsRemaining;

            const churnRate = activeCount ? (cancellations / activeCount) * 100 : 0;
            const arpu = activeCount ? mrr / activeCount : 0;
            const ltv = churnRate ? arpu / (churnRate/100) : 0;
            const cac = newUsers ? marketingCost / newUsers : 0;
            const conversionRate = trialCount ? (newPaidThisMonth / trialCount) * 100 : 0;

            const newUsersChange = prevNewUsers ? ((newUsers - prevNewUsers)/prevNewUsers)*100 : 0;
            const trialChange = prevTrialCount ? ((trialCount - prevTrialCount)/prevTrialCount)*100 : 0;
            const activeChange = prevActiveCount ? ((activeCount - prevActiveCount)/prevActiveCount)*100 : 0;
            const revenueChange = prevMonthlyRevenue ? ((monthlyRevenue - prevMonthlyRevenue)/prevMonthlyRevenue)*100 : 0;

            document.getElementById('newUsers').textContent = newUsers;
            document.getElementById('newUsersChange').textContent = `${newUsersChange.toFixed(1)}%`;
            document.getElementById('trialUsers').textContent = trialCount;
            document.getElementById('trialUsersChange').textContent = `${trialChange.toFixed(1)}%`;
            document.getElementById('activeUsers').textContent = activeCount;
            document.getElementById('activeUsersChange').textContent = `${activeChange.toFixed(1)}%`;
            document.getElementById('monthlySubs').textContent = monthlyCount;
            document.getElementById('yearlySubs').textContent = yearlyCount;
            document.getElementById('monthlyRevenue').textContent = `R$ ${monthlyRevenue.toFixed(2)}`;
            document.getElementById('monthlyRevenueChange').textContent = `${revenueChange.toFixed(1)}%`;
            document.getElementById('projectedRevenue').textContent = `R$ ${projected.toFixed(2)}`;
            document.getElementById('churnRate').textContent = `${churnRate.toFixed(1)}%`;
            document.getElementById('ltv').textContent = `R$ ${ltv.toFixed(2)}`;
            document.getElementById('cac').textContent = `R$ ${cac.toFixed(2)}`;
            document.getElementById('conversionRate').textContent = `${conversionRate.toFixed(1)}%`;

            // Users per month cumulative line
            const usersPerMonth = new Array(12).fill(0);
            usersYear.forEach(u => { usersPerMonth[new Date(u.created_at).getMonth()]++; });
            let cumulative = 0;
            const cumulativeUsers = usersPerMonth.map(v => cumulative += v);

            if (usersCharts.users) usersCharts.users.destroy();
            const ctxUsers = document.getElementById('usersChart').getContext('2d');
            usersCharts.users = new Chart(ctxUsers, {
                type: 'line',
                data: { labels: MONTH_NAMES, datasets: [{ label: 'Usu√°rios', data: cumulativeUsers, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.2)', tension: 0.3 }] },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Plan distribution chart (horizontal bar)
            if (usersCharts.plan) usersCharts.plan.destroy();
            const ctxPlan = document.getElementById('planChart').getContext('2d');
            usersCharts.plan = new Chart(ctxPlan, {
                type: 'bar',
                data: { labels: Object.keys(planCounts), datasets: [{ label: 'Planos', data: Object.values(planCounts), backgroundColor: '#764ba2' }] },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
            });

            // Revenue chart (realized vs projected)
            const realized = new Array(12).fill(0);
            paymentsYear.forEach(p => { realized[new Date(p.paid_at).getMonth()] += p.amount; });
            const projectedArr = [...realized];
            for (let i = now.getMonth(); i < 12; i++) projectedArr[i] = monthlyRevenue;

            if (usersCharts.revenue) usersCharts.revenue.destroy();
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            usersCharts.revenue = new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: MONTH_NAMES,
                    datasets: [
                        { label: 'Realizado', data: realized, borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.2)', tension: 0.2 },
                        { label: 'Projetado', data: projectedArr, borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.2)', borderDash: [5,5], tension: 0.2 }
                    ]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            document.body.classList.remove('refreshing');
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
            const { data } = await supabaseClient
                .from('users')
                .select('id,name,email,specialty,last_login,subscriptions(plan,status)')
                .order('created_at', { ascending: false });
            usersData = (data || []).map(u => {
                const sub = Array.isArray(u.subscriptions) ? u.subscriptions.find(s => s.status === 'active') : u.subscriptions;
                return { ...u, subscription: sub };
            });

            const specialties = [...new Set(usersData.map(u => u.specialty).filter(Boolean))];
            const select = document.getElementById('filterSpecialty');
            select.innerHTML = '<option value="">Todas especialidades</option>';
            specialties.forEach(sp => {
                const opt = document.createElement('option');
                opt.value = sp; opt.textContent = sp; select.appendChild(opt);
            });

            renderUsersTable();
        }

        function renderUsersTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const planFilter = document.getElementById('filterPlan').value;
            const specialtyFilter = document.getElementById('filterSpecialty').value;
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            usersData
                .filter(u => (!search || (u.name + u.email).toLowerCase().includes(search)) &&
                              (!statusFilter || (u.subscription?.status === statusFilter)) &&
                              (
                                  !planFilter ||
                                  (planFilter === 'monthly' && isMonthly(u.subscription?.plan)) ||
                                  (planFilter === 'yearly' && isYearly(u.subscription?.plan)) ||
                                  u.subscription?.plan === planFilter
                              ) &&
                              (!specialtyFilter || u.specialty === specialtyFilter))
                .forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.name || ''}</td>
                        <td>${u.email || ''}</td>
                        <td><span class="status-badge status-${u.subscription?.status || 'unknown'}">${u.subscription?.status || ''}</span></td>
                        <td>${u.subscription?.plan || ''}</td>
                        <td>${u.specialty || ''}</td>
                        <td>${u.last_login ? new Date(u.last_login).toLocaleDateString() : ''}</td>
                        <td><button onclick="openUserModal('${u.id}')">A√ß√µes</button></td>`;
                    tbody.appendChild(tr);
                });
        }

        function applyFilters() { renderUsersTable(); }

        function exportCSV() {
            const rows = [['Nome','Email','Status','Plano','Especialidade','√öltimo login']];
            usersData.forEach(u => rows.push([
                u.name || '',
                u.email || '',
                u.subscription?.status || '',
                u.subscription?.plan || '',
                u.specialty || '',
                u.last_login || ''
            ]));
            const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'usuarios.csv';
            link.click();
        }

        let currentModalUser;

        function openUserModal(id) {
            currentModalUser = usersData.find(u => u.id === id);
            if (!currentModalUser) return;
            document.getElementById('modalName').textContent = currentModalUser.name || '';
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        async function sendEmail() {
            if (!currentModalUser) return;
            await supabaseClient.functions.invoke('send-email', { body: { to: currentModalUser.email } });
            await logAdminAction('send_email', currentModalUser.id);
            showToast('E-mail enviado');
            closeUserModal();
        }

        async function resetPassword() {
            if (!currentModalUser) return;
            await supabaseClient.auth.admin.generateLink({ type: 'recovery', email: currentModalUser.email });
            await logAdminAction('reset_password', currentModalUser.id);
            showToast('Reset de senha enviado');
            closeUserModal();
        }

        async function logAdminAction(action, target) {
            await supabaseClient.from('admin_logs').insert({ action, target_user: target });
        }

        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const div = document.createElement('div');
            div.className = 'toast';
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => div.classList.add('show'), 10);
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function setupRealtime() {
            supabaseClient.channel('admin-listener')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'users' }, payload => {
                    showToast('Novo usu√°rio cadastrado');
                    loadUsers();
                    loadDashboardData();
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'payments' }, payload => {
                    showToast('Nova receita registrada');
                    loadDashboardData();
                })
                .subscribe();
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>

